module.exports=[29211,e=>e.a(async(t,r)=>{try{var n=e.i(43959),o=e.i(50377),a=t([n]);function i(e){let t=new Date(e),r=new Date().getTime()-t.getTime();return Math.floor(r/864e5)}async function s(e){try{let t=(0,n.getAdminDb)();return(await t.collection(e).get()).docs.map(e=>({id:e.id,data:e.data()}))}catch(t){return o.logger.error(`Failed to fetch collection: ${e}`,{},t),[]}}async function l(){let e="findOrphanedCustomerNotes",t=[],r=[];try{o.logger.info("Starting orphaned notes scan",{function:e});let n=await s("customer_notes");if(0===n.length)return o.logger.info("No customer notes found",{function:e}),{count:0,emails:[],orphanedDocIds:[]};let a=await s("orders"),i=new Set;for(let e of(a.forEach(e=>{let t=e.data.customer_email;t&&i.add(t.toLowerCase())}),n)){let n=e.id.toLowerCase();i.has(n)||(t.push(e.id),r.push(e.id))}return o.logger.info("Orphaned notes scan complete",{function:e,orphanedCount:t.length,totalNotes:n.length}),{count:t.length,emails:t,orphanedDocIds:r}}catch(t){return o.logger.error("Error scanning for orphaned notes",{function:e},t),{count:0,emails:[],orphanedDocIds:[]}}}async function d(e=90){let t="purgeStaleWaitlistEntries",r=[],n=[];try{o.logger.info("Starting stale waitlist scan",{function:t,daysOld:e});let a=await s("waitlist");if(0===a.length)return o.logger.info("No waitlist entries found",{function:t}),{count:0,emails:[],staleDocIds:[]};for(let t of a){let o=t.data.signed_up_at;if(o&&i(o)>e){let e=t.data.email;e&&(r.push(e),n.push(t.id))}}return o.logger.info("Stale waitlist scan complete",{function:t,staleCount:r.length,totalEntries:a.length,daysOld:e}),{count:r.length,emails:r,staleDocIds:n}}catch(e){return o.logger.error("Error scanning for stale waitlist entries",{function:t},e),{count:0,emails:[],staleDocIds:[]}}}async function u(){let e="findOrdersWithoutProductRef",t=[],r=[];try{o.logger.info("Starting orders without product ref scan",{function:e});let n=await s("orders");if(0===n.length)return o.logger.info("No orders found",{function:e}),{count:0,orderIds:[],affectedOrders:[]};for(let e of n){let n=e.data.items,o=e.data.customer_email;if(!Array.isArray(n))continue;let a=[];n.forEach((e,t)=>{"object"!=typeof e||null===e||"product_id"in e&&void 0!==e.product_id||a.push(t)}),a.length>0&&(t.push(e.id),r.push({orderId:e.id,affectedItemIndices:a,customer_email:o||"unknown"}))}return o.logger.info("Orders without product ref scan complete",{function:e,affectedCount:t.length,totalOrders:n.length}),{count:t.length,orderIds:t,affectedOrders:r}}catch(t){return o.logger.error("Error scanning for orders without product ref",{function:e},t),{count:0,orderIds:[],affectedOrders:[]}}}async function c(e,t=90){let r="cleanupSoftDeletedRecords",n=[],a=[];try{o.logger.info("Starting soft-deleted records scan",{function:r,collection:e,retentionDays:t});let l=await s(e);if(0===l.length)return o.logger.info(`No ${e} found`,{function:r}),{count:0,ids:[],records:[]};for(let e of l){let r=!0===e.data.is_deleted,o=e.data.deleted_at;if(!r||!o)continue;let s=i(o);s>t&&(n.push(e.id),a.push({id:e.id,deleted_at:o,deletedDaysAgo:s}))}return o.logger.info("Soft-deleted records scan complete",{function:r,collection:e,readyForDeleteCount:n.length,totalRecords:l.length,retentionDays:t}),{count:n.length,ids:n,records:a}}catch(t){return o.logger.error(`Error scanning soft-deleted ${e}`,{function:r},t),{count:0,ids:[],records:[]}}}[n]=a.then?(await a)():a,e.s(["cleanupSoftDeletedRecords",()=>c,"findOrdersWithoutProductRef",()=>u,"findOrphanedCustomerNotes",()=>l,"purgeStaleWaitlistEntries",()=>d]),r()}catch(e){r(e)}},!1),51164,e=>e.a(async(t,r)=>{try{var n=e.i(89171),o=e.i(93458),a=e.i(29211),i=e.i(50377),s=e.i(43959),l=t([a,s]);async function d(e){try{let t=(await (0,o.cookies)()).get("__session");if(!t||!t.value)return i.logger.warn("Admin cleanup endpoint accessed without session cookie",{endpoint:"GET /api/admin/cleanup",ip:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),!1;let r=function(e){try{let t=e.split(".");if(3!==t.length)return null;let r=Buffer.from(t[1],"base64url").toString();return JSON.parse(r)}catch{return null}}(t.value);if(!r?.sub||"string"!=typeof r.sub)return i.logger.warn("Invalid JWT payload in session cookie",{endpoint:"GET /api/admin/cleanup",ip:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),!1;let n=r.sub;try{let t=(0,s.getAdminDb)();if(!(await t.collection("admins").doc(n).get()).exists)return i.logger.warn("Non-admin attempted to access cleanup endpoint",{endpoint:"GET /api/admin/cleanup",uid:n,ip:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),!1;return!0}catch(e){return i.logger.error("Error checking admin status in Firestore",{uid:n,endpoint:"GET /api/admin/cleanup"},e),!1}}catch(e){return i.logger.error("Error verifying admin auth",{endpoint:"GET /api/admin/cleanup"},e),!1}}async function u(e){let t="GET /api/admin/cleanup";try{if(!await d(e))return i.logger.warn("Unauthorized cleanup report access attempt",{endpoint:t,ip:e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")}),n.NextResponse.json({success:!1,generatedAt:new Date().toISOString(),error:"Unauthorized. Admin authentication required."},{status:401});i.logger.info("Cleanup report requested",{endpoint:t,requestedAt:new Date().toISOString()});let[r,o,s,l,u]=await Promise.all([(0,a.findOrphanedCustomerNotes)(),(0,a.purgeStaleWaitlistEntries)(90),(0,a.findOrdersWithoutProductRef)(),(0,a.cleanupSoftDeletedRecords)("products",90),(0,a.cleanupSoftDeletedRecords)("orders",90)]),c=new Date().toISOString();return i.logger.info("Cleanup report generated successfully",{endpoint:t,generatedAt:c,orphanedNotesCount:r.count,staleWaitlistCount:o.count,ordersWithoutProductRefCount:s.count,softDeletedProductsCount:l.count,softDeletedOrdersCount:u.count,totalIssuesFound:r.count+o.count+s.count+l.count+u.count}),n.NextResponse.json({success:!0,report:{orphanedNotes:r,staleWaitlist:o,ordersWithoutProductRef:s,softDeletedProducts:l,softDeletedOrders:u},generatedAt:c},{status:200})}catch(e){return i.logger.error("Error generating cleanup report",{endpoint:t},e),n.NextResponse.json({success:!1,generatedAt:new Date().toISOString(),error:"Internal server error while generating cleanup report."},{status:500})}}async function c(e){return i.logger.warn("POST /api/admin/cleanup attempted",{endpoint:"POST /api/admin/cleanup",message:"Hard deletions not supported via cleanup endpoint"}),n.NextResponse.json({success:!1,error:"POST method not supported. Use GET to retrieve cleanup report only."},{status:405})}[a,s]=l.then?(await l)():l,e.s(["GET",()=>u,"POST",()=>c]),r()}catch(e){r(e)}},!1),22986,e=>e.a(async(t,r)=>{try{var n=e.i(47909),o=e.i(74017),a=e.i(96250),i=e.i(59756),s=e.i(61916),l=e.i(74677),d=e.i(69741),u=e.i(16795),c=e.i(87718),p=e.i(95169),f=e.i(47587),g=e.i(66012),h=e.i(70101),m=e.i(26937),w=e.i(10372),R=e.i(93695);e.i(52474);var E=e.i(220),y=e.i(51164),v=t([y]);[y]=v.then?(await v)():v;let x=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/admin/cleanup/route",pathname:"/api/admin/cleanup",filename:"route",bundlePath:""},distDir:"/sessions/keen-wonderful-keller/.next-verify",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/cleanup/route.ts",nextConfigOutput:"",userland:y}),{workAsyncStorage:O,workUnitAsyncStorage:A,serverHooks:T}=x;function C(){return(0,a.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:A})}async function S(e,t,r){x.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/admin/cleanup/route";n=n.replace(/\/index$/,"")||"/";let a=await x.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:y,params:v,nextConfig:C,parsedUrl:S,isDraftMode:O,prerenderManifest:A,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:D,resolvedPathname:P,clientReferenceManifest:_,serverActionsManifest:I}=a,b=(0,d.normalizeAppPath)(n),k=!!(A.dynamicRoutes[b]||A.routes[P]),U=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,S,!1):t.end("This page could not be found"),null);if(k&&!O){let e=!!A.routes[P],t=A.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await U();throw new R.NoFallbackError}}let H=null;!k||x.isDev||O||(H=P,H="/index"===H?"/":H);let q=!0===x.isDev||!k,M=k&&!q;I&&_&&(0,l.setManifestsSingleton)({page:n,clientReferenceManifest:_,serverActionsManifest:I});let j=e.method||"GET",F=(0,s.getTracer)(),$=F.getActiveScopeSpan(),G={params:v,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,o)=>x.onRequestError(e,t,n,o,T)},sharedContext:{buildId:y}},W=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),L=c.NextRequestAdapter.fromNodeNextRequest(W,(0,c.signalFromNodeResponse)(t));try{let a=async e=>x.handle(L,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${j} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${n}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var s,d;let u=async({previousCacheEntry:o})=>{try{if(!l&&N&&D&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await a(i);e.fetchMetrics=G.renderOpts.fetchMetrics;let s=G.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let d=G.renderOpts.collectedTags;if(!k)return await (0,g.sendResponse)(W,K,n,G.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,o=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==o?void 0:o.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:N})},!1,T),t}},c=await x.handleResponse({req:e,nextConfig:C,cacheKey:H,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:D,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:l});if(!k)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",N?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),O&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&k||p.delete(w.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)(W,K,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};$?await d($):await F.withPropagatedContext(e.headers,()=>F.trace(p.BaseServerSpan.handleRequest,{spanName:`${j} ${n}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},d))}catch(t){if(t instanceof R.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:N})},!1,T),k)throw t;return await (0,g.sendResponse)(W,K,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>C,"routeModule",()=>x,"serverHooks",()=>T,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>A]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_ef9018e9._.js.map