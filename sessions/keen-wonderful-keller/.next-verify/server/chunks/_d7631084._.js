module.exports=[15933,e=>e.a(async(t,r)=>{try{var a=e.i(43959),i=e.i(27817),n=e.i(50377),o=t([a,i]);async function s(e,t,r){try{let n=(0,a.getAdminDb)();await n.collection("admin_audit_log").add({action:e,details:t,admin_email:r||"system",timestamp:i.FieldValue.serverTimestamp(),created_at:new Date().toISOString(),server_logged:!0})}catch(t){n.logger.error("Server audit log write failed",{action:e},t)}}[a,i]=o.then?(await o)():o,e.s(["logAdminActionServer",()=>s]),r()}catch(e){r(e)}},!1),2587,e=>e.a(async(t,r)=>{try{var a=e.i(89171),i=e.i(69719),n=e.i(84970),o=e.i(89104),s=e.i(60826),l=e.i(50377),d=e.i(43959),c=e.i(27817),u=e.i(73638),p=e.i(15933),m=t([n,d,c,p]);[n,d,c,p]=m.then?(await m)():m;let g=i.z.object({productId:i.z.string().min(1),size:i.z.string().min(1),color:i.z.string().optional(),quantity:i.z.number().int().min(1).max(10),declaredPrice:i.z.number().min(0).max(1e5)}),f=i.z.object({items:i.z.array(g).min(1).max(50),customerEmail:i.z.string().email().max(254),shippingAddress:i.z.object({name:i.z.string().min(1).max(200),line1:i.z.string().min(1).max(300),line2:i.z.string().max(300).optional(),city:i.z.string().min(1).max(100),state:i.z.string().min(1).max(100),postalCode:i.z.string().min(1).max(20),country:i.z.enum(["CA","US"])}),discountCode:i.z.string().max(50).optional(),idempotency_key:i.z.string().optional()});async function h(e){try{if(!(await (0,s.validateCSRF)(e)).valid)return a.NextResponse.json({error:"Invalid request"},{status:403});let t=(0,o.getClientIP)(e);if(!(await (0,o.rateLimit)(`orders-create:${t}`,o.RATE_LIMITS.ordersCreate)).allowed)return a.NextResponse.json({error:"Too many requests"},{status:429});let r=await e.json(),i=f.safeParse(r);if(!i.success)return a.NextResponse.json({error:"Validation failed",details:i.error.flatten().fieldErrors},{status:400});let{items:m,customerEmail:h,shippingAddress:g,discountCode:R,idempotency_key:v}=i.data;if(v){let e=await (0,d.getAdminDb)().collection("orders").where("idempotency_key","==",v).limit(1).get();if(!e.empty){let t=e.docs[0];return a.NextResponse.json({success:!0,orderId:t.id,message:"Order already processed",duplicate:!0})}}let y=(0,u.sanitizeEmail)(h),w={name:(0,u.sanitizeString)(g.name),line1:(0,u.sanitizeString)(g.line1),line2:g.line2?(0,u.sanitizeString)(g.line2):void 0,city:(0,u.sanitizeString)(g.city),state:(0,u.sanitizeString)(g.state),postalCode:g.postalCode,country:g.country},x=(0,d.getAdminDb)(),C=0;for(let e of m){let r=await x.collection("products").doc(e.productId).get();if(!r.exists)return a.NextResponse.json({error:`Product ${e.productId} not found`},{status:400});let i=r.data();if(!0===i.is_deleted||!1===i.is_active)return a.NextResponse.json({error:"One or more products are no longer available. Please refresh your cart."},{status:409});let n=i.price;if(Math.abs(n-e.declaredPrice)>.01)return l.logger.warn("Price mismatch detected",{productId:e.productId,declared:e.declaredPrice,actual:n,ip:t}),a.NextResponse.json({error:"Price has changed. Please refresh and try again."},{status:409});C+=n*e.quantity}let E=0;if(R){let e=await x.runTransaction(async e=>{let t=await x.collection("discounts").where("code","==",R.toUpperCase()).limit(1).get();if(t.empty)return{error:"Invalid discount code",status:400};let r=t.docs[0],a=await e.get(r.ref);if(!a.exists)return{error:"Invalid discount code",status:400};let i=a.data();if(!1===i.active)return{error:"This discount code is no longer active",status:400};if(i.expiresAt&&new Date(i.expiresAt)<new Date)return{error:"This discount code has expired",status:400};if(i.maxUses>0&&(i.currentUses||0)>=i.maxUses)return{error:"This discount code has reached its usage limit",status:400};if(i.minOrder&&C<i.minOrder)return{error:`Minimum order of $${i.minOrder} required for this code`,status:400};let n=0;return"percentage"===i.type?n=Math.min(i.value,100)/100*C:"fixed"===i.type&&(n=Math.min(i.value,C)),e.update(r.ref,{currentUses:c.FieldValue.increment(1)}),{amount:n,error:null}});if(e.error)return a.NextResponse.json({error:e.error},{status:e.status||400});E=e.amount}let A=`temp-${Date.now()}-${crypto.randomUUID().replace(/-/g,"").slice(0,9)}`,_=await (0,n.decrementStockTransaction)(m,A);if(!_.success){if(R)try{let e=await x.collection("discounts").where("code","==",R.toUpperCase()).limit(1).get();e.empty||await e.docs[0].ref.update({currentUses:c.FieldValue.increment(-1)})}catch(e){l.logger.error("Failed to rollback discount usage",{discountCode:R},e)}return a.NextResponse.json({error:_.error||"Stock unavailable"},{status:409})}let T=Math.max(0,C-E),b={items:m.map(e=>({productId:e.productId,size:e.size,color:e.color||null,quantity:e.quantity,price:e.declaredPrice})),customer_email:y,shipping_address:w,subtotal:C,discount:E,total:T,donation:.1*T,status:"pending",payment_status:"pending",created_at:c.FieldValue.serverTimestamp(),updated_at:c.FieldValue.serverTimestamp(),...v&&{idempotency_key:v}},I=await x.collection("orders").add(b);return l.logger.info("Order created",{orderId:I.id,total:b.total,ip:t}),(0,p.logAdminActionServer)("order_created_server",{orderId:I.id,itemCount:m.length,total:b.total,ip:t}).catch(()=>{}),a.NextResponse.json({success:!0,orderId:I.id,total:b.total},{status:201})}catch(e){return l.logger.error("Order creation error",{route:"/api/orders/create"},e),a.NextResponse.json({error:"Internal server error"},{status:500})}}e.s(["POST",()=>h]),r()}catch(e){r(e)}},!1),2821,e=>e.a(async(t,r)=>{try{var a=e.i(47909),i=e.i(74017),n=e.i(96250),o=e.i(59756),s=e.i(61916),l=e.i(74677),d=e.i(69741),c=e.i(16795),u=e.i(87718),p=e.i(95169),m=e.i(47587),h=e.i(66012),g=e.i(70101),f=e.i(26937),R=e.i(10372),v=e.i(93695);e.i(52474);var y=e.i(220),w=e.i(2587),x=t([w]);[w]=x.then?(await x)():x;let A=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/orders/create/route",pathname:"/api/orders/create",filename:"route",bundlePath:""},distDir:"/sessions/keen-wonderful-keller/.next-verify",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/orders/create/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:_,workUnitAsyncStorage:T,serverHooks:b}=A;function C(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:T})}async function E(e,t,r){A.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/orders/create/route";a=a.replace(/\/index$/,"")||"/";let n=await A.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:x,nextConfig:C,parsedUrl:E,isDraftMode:_,prerenderManifest:T,routerServerContext:b,isOnDemandRevalidate:I,revalidateOnlyGenerated:P,resolvedPathname:S,clientReferenceManifest:N,serverActionsManifest:O}=n,z=(0,d.normalizeAppPath)(a),U=!!(T.dynamicRoutes[z]||T.routes[S]),j=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,E,!1):t.end("This page could not be found"),null);if(U&&!_){let e=!!T.routes[S],t=T.dynamicRoutes[z];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await j();throw new v.NoFallbackError}}let k=null;!U||A.isDev||_||(k=S,k="/index"===k?"/":k);let q=!0===A.isDev||!U,D=U&&!q;O&&N&&(0,l.setManifestsSingleton)({page:a,clientReferenceManifest:N,serverActionsManifest:O});let M=e.method||"GET",H=(0,s.getTracer)(),F=H.getActiveScopeSpan(),$={params:x,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>A.onRequestError(e,t,a,i,b)},sharedContext:{buildId:w}},V=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),L=u.NextRequestAdapter.fromNodeNextRequest(V,(0,u.signalFromNodeResponse)(t));try{let n=async e=>A.handle(L,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${M} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${a}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var s,d;let c=async({previousCacheEntry:i})=>{try{if(!l&&I&&P&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(o);e.fetchMetrics=$.renderOpts.fetchMetrics;let s=$.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let d=$.renderOpts.collectedTags;if(!U)return await (0,h.sendResponse)(V,K,a,$.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[R.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,i=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:I})},!1,b),t}},u=await A.handleResponse({req:e,nextConfig:C,cacheKey:k,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:P,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:l});if(!U)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",I?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),_&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&U||p.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(V,K,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};F?await d(F):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${M} ${a}`,kind:s.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:z,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:I})},!1,b),U)throw t;return await (0,h.sendResponse)(V,K,new Response(null,{status:500})),null}}e.s(["handler",()=>E,"patchFetch",()=>C,"routeModule",()=>A,"serverHooks",()=>b,"workAsyncStorage",()=>_,"workUnitAsyncStorage",()=>T]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_d7631084._.js.map