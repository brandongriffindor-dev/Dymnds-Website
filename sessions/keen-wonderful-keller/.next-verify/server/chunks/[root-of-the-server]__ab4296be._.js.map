{"version":3,"sources":["../../../../../src/lib/logger.ts","../../../../../src/lib/firebase-admin.ts"],"sourcesContent":["/**\n * Structured JSON logger for production observability [INF-106].\n *\n * Outputs structured JSON to stdout/stderr for Vercel Logs ingestion.\n * Vercel automatically parses JSON log lines into searchable, filterable fields.\n *\n * Usage:\n *   import { logger } from '@/lib/logger';\n *   logger.info('Order created', { orderId: '123', total: 99.99 });\n *   logger.error('Payment failed', { orderId: '123' }, error);\n */\n\ntype LogLevel = 'debug' | 'info' | 'warn' | 'error';\n\ninterface LogEntry {\n  level: LogLevel;\n  message: string;\n  timestamp: string;\n  context?: Record<string, unknown>;\n  error?: {\n    name: string;\n    message: string;\n    stack?: string;\n  };\n}\n\n// PII fields to mask in log output\nconst PII_FIELDS = new Set(['email', 'customer_email', 'customerEmail', 'phone', 'password', 'token', 'idToken', 'creditCard', 'ssn']);\n\nfunction maskPII(context: Record<string, unknown>): Record<string, unknown> {\n  const masked = { ...context };\n  for (const [key, value] of Object.entries(masked)) {\n    if (typeof value === 'string' && PII_FIELDS.has(key)) {\n      // Show first 3 chars + mask remainder\n      masked[key] = value.length > 3 ? value.slice(0, 3) + '***' : '***';\n    } else if (typeof value === 'object' && value !== null && !Array.isArray(value)) {\n      masked[key] = maskPII(value as Record<string, unknown>);\n    }\n  }\n  return masked;\n}\n\nfunction createLogEntry(\n  level: LogLevel,\n  message: string,\n  context?: Record<string, unknown>,\n  error?: unknown\n): LogEntry {\n  const entry: LogEntry = {\n    level,\n    message,\n    timestamp: new Date().toISOString(),\n  };\n\n  if (context && Object.keys(context).length > 0) {\n    entry.context = maskPII(context);\n  }\n\n  if (error instanceof Error) {\n    entry.error = {\n      name: error.name,\n      message: error.message,\n      stack: error.stack,\n    };\n  } else if (error) {\n    entry.error = {\n      name: 'UnknownError',\n      message: String(error),\n    };\n  }\n\n  return entry;\n}\n\nfunction emit(entry: LogEntry): void {\n  const json = JSON.stringify(entry);\n\n  if (entry.level === 'error' || entry.level === 'warn') {\n    console.error(json);\n  } else {\n    console.log(json);\n  }\n}\n\nexport const logger = {\n  debug(message: string, context?: Record<string, unknown>): void {\n    if (process.env.NODE_ENV === 'development') {\n      emit(createLogEntry('debug', message, context));\n    }\n  },\n\n  info(message: string, context?: Record<string, unknown>): void {\n    emit(createLogEntry('info', message, context));\n  },\n\n  warn(message: string, context?: Record<string, unknown>, error?: unknown): void {\n    emit(createLogEntry('warn', message, context, error));\n  },\n\n  error(message: string, context?: Record<string, unknown>, error?: unknown): void {\n    emit(createLogEntry('error', message, context, error));\n  },\n};\n","/**\n * Firebase Admin SDK — server-side only.\n *\n * Bypasses Firestore Security Rules (trusted server context).\n * Used by API routes to read/write Firestore without client auth.\n *\n * Requires FIREBASE_SERVICE_ACCOUNT_KEY env var (JSON string)\n * set in Vercel Dashboard → Settings → Environment Variables.\n */\n\nimport { initializeApp, getApps, cert, type App } from 'firebase-admin/app';\nimport { getFirestore, type Firestore, FieldValue } from 'firebase-admin/firestore';\nimport { logger } from '@/lib/logger';\n\nlet adminApp: App | null = null;\nlet adminDb: Firestore | null = null;\n\nfunction initializeAdminSDK(): App {\n  if (adminApp) return adminApp;\n\n  const existing = getApps();\n  if (existing.length > 0) {\n    adminApp = existing[0];\n    return adminApp;\n  }\n\n  const serviceAccountKey = process.env.FIREBASE_SERVICE_ACCOUNT_KEY;\n  if (!serviceAccountKey) {\n    throw new Error(\n      'FIREBASE_SERVICE_ACCOUNT_KEY is not set. ' +\n      'Add it in Vercel Dashboard → Settings → Environment Variables.'\n    );\n  }\n\n  let serviceAccount: Record<string, string>;\n  try {\n    serviceAccount = JSON.parse(serviceAccountKey);\n  } catch {\n    throw new Error(\n      'FIREBASE_SERVICE_ACCOUNT_KEY is not valid JSON. ' +\n      'Paste the entire contents of your service account JSON file.'\n    );\n  }\n\n  adminApp = initializeApp({\n    credential: cert(serviceAccount),\n  });\n\n  logger.info('Firebase Admin SDK initialized', {\n    projectId: serviceAccount.project_id,\n  });\n\n  return adminApp;\n}\n\n/**\n * Get the Admin Firestore instance (server-side, bypasses security rules).\n * Lazy-initializes on first call.\n */\nexport function getAdminDb(): Firestore {\n  if (adminDb) return adminDb;\n  const app = initializeAdminSDK();\n  adminDb = getFirestore(app);\n  return adminDb;\n}\n\n// Re-export FieldValue for serverTimestamp, increment, etc.\nexport { FieldValue };\n"],"names":[],"mappings":"mmCA2BA,IAAM,EAAa,IAAI,IAAI,CAAC,QAAS,iBAAkB,gBAAiB,QAAS,WAAY,QAAS,UAAW,aAAc,MAAM,EAerI,SAAS,EACP,CAAe,CACf,CAAe,CACf,CAAiC,CACjC,CAAe,EAEf,IAAM,EAAkB,OACtB,UACA,EACA,UAAW,IAAI,OAAO,WAAW,EACnC,EAmBA,OAjBI,GAAW,OAAO,IAAI,CAAC,GAAS,MAAM,CAAG,GAAG,AAC9C,GAAM,OAAO,CAAG,AA1BpB,SAAS,EAAQ,CAAgC,EAC/C,IAAM,EAAS,CAAE,GAAG,CAAO,AAAC,EAC5B,IAAK,GAAM,CAAC,EAAK,EAAM,GAAI,OAAO,OAAO,CAAC,GACnB,KAD4B,KAC7C,OAAO,GAAsB,EAAW,GAAG,CAAC,GAE9C,CAAM,CAAC,CAF6C,CAEzC,CAAG,EAAM,MAAM,CAAG,EAAI,EAAM,KAAK,CAAC,EAAG,GAAK,MAAQ,MACnC,UAAjB,OAAO,GAAgC,OAAV,CAAkB,EAAC,MAAM,OAAO,CAAC,KACvE,CAAM,CAAC,CADwE,CACpE,CAAG,EAAQ,EAAA,EAG1B,OAAO,CACT,EAe4B,EAAA,EAGtB,aAAiB,MACnB,CAD0B,CACpB,KAAK,CAAG,CACZ,KAAM,EAAM,IAAI,CAChB,QAAS,EAAM,OAAO,CACtB,MAAO,EAAM,KAAK,AACpB,EACS,IACT,EAAM,CADU,IACL,CAAG,CACZ,KAAM,eACN,QAAS,OAAO,GAClB,EAGK,CACT,CAEA,SAAS,EAAK,CAAe,EAC3B,IAAM,EAAO,KAAK,SAAS,CAAC,GAER,UAAhB,EAAM,KAAK,EAAgC,AAAhB,QAAwB,GAAlB,KAAK,CACxC,QAAQ,KAAK,CAAC,GAEd,QAAQ,GAAG,CAAC,EAEhB,iBAEsB,CACpB,MAAM,CAAe,CAAE,CAAiC,EAIxD,EAEA,KAAK,CAAe,CAAE,CAAiC,EACrD,EAAK,EAAe,OAAQ,EAAS,GACvC,EAEA,KAAK,CAAe,CAAE,CAAiC,CAAE,CAAe,EACtE,EAAK,EAAe,OAAQ,EAAS,EAAS,GAChD,EAEA,MAAM,CAAe,CAAE,CAAiC,CAAE,CAAe,EACvE,EAAK,EAAe,QAAS,EAAS,EAAS,GACjD,CACF,mCC5FA,IAAA,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,6CAEA,IAAI,EAAuB,KACvB,EAA4B,KA4CzB,SAAS,IACd,GAAI,EAAS,OAAO,EACpB,IAAM,EAAM,AA5Cd,SAAS,MAiBH,EAhBJ,GAAI,EAAU,OAAO,EAErB,IAAM,EAAW,CAAA,EAAA,EAAA,OAAA,AAAO,IACxB,GAAI,EAAS,MAAM,CAAG,EAEpB,CAFuB,MACvB,AACO,EADI,CAAQ,CAAC,EAAE,CAIxB,IAAM,EAAoB,QAAQ,GAAG,CAAC,4BAA4B,CAClE,GAAI,CAAC,EACH,MAAU,AAAJ,MACJ,KAFoB,yCAGpB,6DAKJ,GAAI,CACF,EAAiB,KAAK,KAAK,CAAC,EAC9B,CAAE,KAAM,CACN,MAAM,AAAI,MACR,qDACA,0DAEJ,CAUA,OARA,EAAW,CAAA,EAAA,EAAA,aAAa,AAAb,EAAc,CACvB,WAAY,CAAA,EAAA,EAAA,IAAA,AAAI,EAAC,EACnB,GAEA,EAAA,MAAM,CAAC,IAAI,CAAC,iCAAkC,CAC5C,UAAW,EAAe,UAAU,AACtC,GAEO,CACT,IAUE,OADA,AACO,EADG,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAEzB"}